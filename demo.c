#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include <complex.h>

#define N_FFT 64  // FFT Size
#define fc_hz 5e9  // Carrier frequency (5 GHz)
#define fs_hz 20e6  // Sampling frequency (20 MHz)
#define ts_sec (1/fs_hz)  // Time period (50 ns)
#define PI 3.14159265358979323846
#define M 4 // QPSK Modulation
#define size_96 96
#define size_48 48
#define size_snr_db 10
#define FRAME_TX_LENGTH 480
#define TS_SEC 5e-8


complex double* ifft(complex double *X, int N) {
    if (N <= 1) return X;
    
    complex double *even = (complex double *)malloc(N / 2 * sizeof(complex double));
    complex double *odd = (complex double *)malloc(N / 2 * sizeof(complex double));

    for (int i = 0; i < N / 2; i++) {
        even[i] = X[i * 2];
        odd[i] = X[i * 2 + 1];
    }
    
    even = ifft(even, N / 2);
    odd = ifft(odd, N / 2);

    complex double *X_out = (complex double *)malloc(N * sizeof(complex double));
    for (int k = 0; k < N / 2; k++) {
        complex double t = cexp(I * 2.0 * PI * k / N) * odd[k];
        X_out[k] = (even[k] + t) / 2.0;
        X_out[k + N / 2] = (even[k] - t) / 2.0;
    }
    
    free(even);
    free(odd);
    return X_out;
}

complex double* fft(complex double *X, int N) {
    if (N <= 1) return X;
    
    complex double *even = (complex double *)malloc(N / 2 * sizeof(complex double));
    complex double *odd = (complex double *)malloc(N / 2 * sizeof(complex double));

    for (int i = 0; i < N / 2; i++) {
        even[i] = X[i * 2];
        odd[i] = X[i * 2 + 1];
    }
    
    even = fft(even, N / 2);
    odd = fft(odd, N / 2);

    complex double *X_out = (complex double *)malloc(N * sizeof(complex double));
    for (int k = 0; k < N / 2; k++) {
        complex double t = cexp(-I * 2.0 * PI * k / N) * odd[k];
        X_out[k] = even[k] + t;
        X_out[k + N / 2] = even[k] - t;
    }
    
    free(even);
    free(odd);
    return X_out;
}

complex double* ifftshift(complex double *X, int N) {
    complex double *X_out = (complex double *)malloc(N * sizeof(complex double));
    int half = N / 2;

    for (int i = 0; i < half; i++) {
        X_out[i] = X[i + half];
        X_out[i + half] = X[i];
    }

    return X_out;
}

complex double* fftshift(complex double *X, int N) {
    complex double *X_out = (complex double *)malloc(N * sizeof(complex double));
    int half = N / 2;

    for (int i = 0; i < half; i++) {
        X_out[i] = X[i + half];
        X_out[i + half] = X[i];
    }

    return X_out;
}

complex double *repeat_short_preamble(complex double *arr){
    double complex *repeated_array= (complex double *)malloc(160 * sizeof(complex double));

    for(int a=0;a<10;a++){
        for(int b=0;b<16;b++){
            repeated_array[a*16+b]=arr[b];
        }   
    }
    return repeated_array;
}
complex double* repeat_long_preamble(complex double *arr) {
    complex double *repeated_array = (complex double *)malloc(160 * sizeof(complex double));
    
    for (int i = 0; i < 32; i++) {
        repeated_array[i] = arr[i + 32];
    }
    for (int i = 0; i < 64; i++) {
        repeated_array[i + 32] = arr[i];
        repeated_array[i + 96] = arr[i];
    }
    
    return repeated_array;
}

complex double sign_complex(complex double complex_num){
    complex double complex_out;

    double magnitude=sqrt(creal(complex_num)*creal(complex_num)+cimag(complex_num)*cimag(complex_num));
    if (magnitude == 0) {
        complex_out = 0.0 + 0.0 * I;  
        return complex_out;
    }
    else{   
        complex_out=complex_num/magnitude;
        return complex_out;
    }
}

double check_values(double *arr, double check_num, double replace_num){
    for(int i=0;i<size_snr_db;i++){
        if(arr[i]==check_num || arr[i]<check_num){
            arr[i]=replace_num;
        }
    }
    return *arr;
}

int main() { 

//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Coarse CFO Estimation %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%    

    int Short_preamble_slot_length=16;
    double complex rx_frame[480]={0.0398445495652047 + 0.0460266225825575*I,	-0.152732461436982 + 0.00211581276889430*I,	-0.0370813122119443 - 0.0784927549221205*I,	0.122137468123988 - 0.0123949926084126*I,	0.0751644527552184 - 0.000420235969106398*I,	0.150077889828078 - 0.0126048880673216*I,	-0.0338047200386434 - 0.0782038438723942*I,	-0.149132954172048 + 0.00213037683701589*I,	0.0518469561765076 + 0.0463689972461208*I,	-0.00292829736027566 - 0.132407837357046*I,	-0.0744466365983364 - 0.0138485010567975*I,	-0.0301511825697242 + 0.142760581156266*I,	-0.0158603772440592 + 0.0921098548113164*I,	-0.0171707430574604 + 0.142760581156266*I,	-0.0832457300564309 - 0.0138485010567975*I,	-0.000388815450428872 - 0.132407864742532*I,	0.0143180715016648 + 0.0463664769517295*I,	-0.151545165518863 + 0.00211654526545519*I,	-0.0166075197417241 - 0.0781924898112058*I,	0.156252289265523 - 0.0124692616791892*I,	0.114677160107677 - 0.000760826978768842*I,	0.165706552582717 - 0.0124692616791892*I,	-0.0224992844156965 - 0.0781924898112057*I,	-0.130084876437458 + 0.00211654526545519*I,	0.0505865313886829 + 0.0463664769517294*I,	0.0252189084121096 - 0.132407864742532*I,	-0.0800227636729310 - 0.0138485010567975*I,	0.00754537134155381 + 0.142760581156266*I,	-0.00955721940689646 + 0.0921098548113164*I,	-0.0206862756059935 + 0.142760581156266*I,	-0.0717555528388952 - 0.0138485010567975*I,	0.00430544394978920 - 0.132407864742532*I,	0.0462925928100004 + 0.0463664769517295*I,	-0.143001691393318 + 0.00211654526545519*I,	-0.0419153850923185 - 0.0781924898112058*I,	0.120834809001457 - 0.0124692616791892*I,	0.105183613253761 - 0.000760826978768842*I,	0.139103599107174 - 0.0124692616791892*I,	-0.0184761172926752 - 0.0781924898112057*I,	-0.135952457459999 + 0.00211654526545519*I,	0.0675994943178751 + 0.0463664769517294*I,	-0.000846728182626149 - 0.132407864742532*I,	-0.0798658575402743 - 0.0138485010567975*I,	-0.00194739737606668 + 0.142760581156266*I,	0.0140186662289602 + 0.0921098548113164*I,	-0.000693303828611924 + 0.142760581156266*I,	-0.0601835991811711 - 0.0138485010567975*I,	-0.0219233611631631 - 0.132407864742532*I,	0.0546589414459631 + 0.0463664769517295*I,	-0.138854385020861 + 0.00211654526545519*I,	-0.000525231556243883 - 0.0781924898112058*I,	0.132075301321280 - 0.0124692616791892*I,	0.0669433857106862 - 0.000760826978768842*I,	0.128695054917462 - 0.0124692616791892*I,	-0.0270352635035159 - 0.0781924898112057*I,	-0.118033931617506 + 0.00211654526545519*I,	0.0458357466068873 + 0.0463664769517294*I,	0.0255216933343832 - 0.132407864742532*I,	-0.0607979171650260 - 0.0138485010567975*I,	-0.0201073067769861 + 0.142760581156266*I,	0.0286798139711460 + 0.0921098548113164*I,	-0.0236140838823031 + 0.142760581156266*I,	-0.0787344756451332 - 0.0138485010567975*I,	0.00725777804591409 - 0.132407864742532*I,	0.0316387725218602 + 0.0463664769517295*I,	-0.133007083320035 + 0.00211654526545519*I,	-0.0183542507461272 - 0.0781924898112058*I,	0.153296025913056 - 0.0124692616791892*I,	0.0795743161622254 - 0.000760826978768842*I,	0.134257937355725 - 0.0124692616791892*I,	-0.00537472693795167 - 0.0781924898112057*I,	-0.143199950030510 + 0.00211654526545519*I,	0.0515175535841026 + 0.0463664769517294*I,	0.0213809614129660 - 0.132407864742532*I,	-0.0903038367621915 - 0.0138485010567975*I,	0.00215172159396166 + 0.142760581156266*I,	-0.00317865823210433 + 0.0921098548113164*I,	0.00518280676068612 + 0.142760581156266*I,	-0.0695006713955121 - 0.0138485010567975*I,	0.00469638327860587 - 0.132407864742532*I,	0.0458288519777912 + 0.0463664769517295*I,	-0.151579900364493 + 0.00211654526545519*I,	-0.0225046764941062 - 0.0781924898112058*I,	0.154576694063837 - 0.0124692616791892*I,	0.125408812909784 - 0.000760826978768842*I,	0.158382307067033 - 0.0124692616791892*I,	-0.0156740021099000 - 0.0781924898112057*I,	-0.152984202466010 + 0.00211654526545519*I,	0.0532878512325934 + 0.0463664769517294*I,	-0.0117190841439535 - 0.132407864742532*I,	-0.0855434682620441 - 0.0138485010567975*I,	-0.00272693802425842 + 0.142760581156266*I,	0.0150577026183233 + 0.0921098548113164*I,	-0.0390439214846382 + 0.142760581156266*I,	-0.0831485205531064 - 0.0138485010567975*I,	0.0143497109110969 - 0.132407864742532*I,	0.0329792022648304 + 0.0463664769517295*I,	-0.124695383571539 + 0.00211654526545519*I,	-0.00717924147515624 - 0.0781924898112058*I,	0.146197416435099 - 0.0124692616791892*I,	0.0769970771940904 - 0.000760826978768842*I,	0.160821533576639 - 0.0124692616791892*I,	-0.0367655591022035 - 0.0781924898112057*I,	-0.127122177835717 + 0.00211654526545519*I,	0.0433324841361760 + 0.0463664769517294*I,	-0.0225814422976934 - 0.132407864742532*I,	-0.0617656263989450 - 0.0138485010567975*I,	-0.00108444685452721 + 0.142760581156266*I,	-0.00459453025123253 + 0.0921098548113164*I,	-0.0220700586505429 + 0.142760581156266*I,	-0.0975411454129326 - 0.0138485010567975*I,	0.0113446974582830 - 0.132407864742532*I,	0.0609149374179239 + 0.0463664769517295*I,	-0.119872451221438 + 0.00211654526545519*I,	-0.00183923628964124 - 0.0781924898112058*I,	0.142597934660630 - 0.0124692616791892*I,	0.0766970558552674 - 0.000760826978768842*I,	0.153097459040023 - 0.0124692616791892*I,	-0.00930451673783650 - 0.0781924898112057*I,	-0.129674743867184 + 0.00211654526545519*I,	0.0650282326883596 + 0.0463664769517294*I,	-0.000614270653427495 - 0.132407864742532*I,	-0.0938316740919818 - 0.0138485010567975*I,	-0.0302251661983526 + 0.142760581156266*I,	-0.00645327043864846 + 0.0921098548113164*I,	-0.00902318666925901 + 0.142760581156266*I,	-0.0468327908006936 - 0.0138485010567975*I,	0.0181383271958862 - 0.132407864742532*I,	0.0442920537874402 + 0.0463664769517295*I,	-0.142695370253987 + 0.00211654526545519*I,	-0.00380676492685210 - 0.0781924898112058*I,	0.123090544485755 - 0.0124692616791892*I,	0.0986061465407723 - 0.000760826978768842*I,	0.158207841618422 - 0.0124692616791892*I,	-0.0305096419621416 - 0.0781924898112057*I,	-0.137077525540182 + 0.00211654526545519*I,	0.0193490243069688 + 0.0463664769517294*I,	0.0113940461952563 - 0.132407864742532*I,	-0.0891932988250916 - 0.0138485010567975*I,	-0.0296510670973406 + 0.142760581156266*I,	0.0159308159548111 + 0.0921098548113164*I,	-0.0113994191279373 + 0.142760581156266*I,	-0.0560396526587473 - 0.0138485010567975*I,	0.0141871624228268 - 0.132407864742532*I,	0.0568395895055171 + 0.0463664769517295*I,	-0.148038758019682 + 0.00211654526545519*I,	-0.00953870034606664 - 0.0781924898112058*I,	0.157745499006437 - 0.0124692616791892*I,	0.0789033876243233 - 0.000760826978768842*I,	0.127689886375437 - 0.0124692616791892*I,	-0.00942293601024707 - 0.0781924993224026*I,	-0.139429747928833 + 0.00211565025022764*I,	0.0392353375986019 + 0.0463598465162352*I,	0.0143768728881999 - 0.132415196796536*I,	-0.0780973852467471 - 0.0138046792748297*I,	-0.00310540269489233 + 0.142717338870993*I,	-0.0131539117831271 + 0.0918993947903973*I,	-0.0358068180170515 + 0.142857892199911*I,	-0.0931499346133445 - 0.0140547521987799*I,	0.00564499727947451 - 0.132583148979660*I,	-0.139926823476601 + 0.000556933205646855*I,	0.0215816951605179 - 0.0976302638155072*I,	0.127262182075223 - 0.105699678546547*I,	-0.106176268931870 - 0.114833428909700*I,	0.0135636748840098 - 0.0540951440039524*I,	0.0839499686236429 + 0.0740007065742428*I,	-0.131663140108856 + 0.0204312355687776*I,	-0.102851674622485 + 0.0162652259015624*I,	-0.0383946652579664 + 0.150633441460925*I,	-0.0426301240396854 + 0.0217361209596384*I,	-0.0593778425111135 - 0.0813567750697002*I,	0.0571177090331417 - 0.0139293559275895*I,	0.100995423398922 - 0.0923296031097981*I,	-0.133882725487659 - 0.0653067950261394*I,	-0.0788648080165016 - 0.0392339052310190*I,	0.0113284647145724 - 0.0984796870913278*I,	0.0483780932730601 + 0.0625717177384289*I,	0.0977114937323417 + 0.00419021691798917*I,	-0.0376844063672350 - 0.160817263460687*I,	0.0581343148950529 + 0.0149341343386967*I,	0.0318046283262621 + 0.0584626724772317*I,	-0.113731122664283 + 0.0476376735221861*I,	0.00917914276484241 + 0.115312365181718*I,	0.0805583515636225 - 0.00456713133592963*I,	0.0987866623457287 + 0.0257435101612987*I,	-0.0594980371804703 + 0.106533306444449*I,	-0.127118662017022 + 0.0554262475141345*I,	0.0300124114382421 + 0.0880153378370228*I,	0.0342710084093928 - 0.0282287964756763*I,	0.102856500151324 - 0.0830743912342874*I,	0.0564514142830461 + 0.111659929030848*I,	0.0291780187744841 + 0.120398625428305*I,	0.165097821318256 + 3.72016870434089e-18*I,	-0.00504049749429051 - 0.120398625428305*I,	0.0426046190420682 - 0.111659929030848*I,	0.0977982720643964 + 0.0830743912342874*I,	0.0214202904217308 + 0.0282287964756764*I,	0.0424698319584415 - 0.0880153378370227*I,	-0.136419806253061 - 0.0554262475141345*I,	-0.0451905887735168 - 0.106533306444449*I,	0.102575789171601 - 0.0257435101612987*I,	0.0559085278250639 + 0.00456713133592964*I,	0.00969048396650435 - 0.115312365181718*I,	-0.142922950862261 - 0.0476376735221861*I,	0.0454806556609859 - 0.0584626724772317*I,	0.0617808670715893 - 0.0149341343386967*I,	-0.0289210544836890 + 0.160817263460687*I,	0.0983807465079470 - 0.00419021691798916*I,	0.0373008479553954 - 0.0625717177384289*I,	0.0314880257342689 + 0.0984796870913278*I,	-0.0540217462867806 + 0.0392339052310190*I,	-0.122141442225314 + 0.0653067950261394*I,	0.0869467688077585 + 0.0923296031097981*I,	0.0583459829258082 + 0.0139293559275895*I,	-0.0732109372598328 + 0.0813567750697002*I,	-0.0755873534809514 - 0.0217361685258572*I,	-0.0423178816283093 - 0.150637838832394*I,	-0.125019037180502 - 0.0162911194072054*I,	-0.131824784946380 - 0.0204255832742890*I,	0.0685718277433700 - 0.0737828370699734*I,	-0.0264752961613876 + 0.0535927383449640*I,	-0.104524674139630 + 0.114651158755971*I,	0.0816803672466968 + 0.105807639400546*I,	0.0252220047701497 + 0.0974871323196164*I,	-0.146161685267147 - 5.55653613398821e-19*I,	-0.0164866903369389 - 0.0974871323196164*I,	0.0737065557080320 - 0.105807639400546*I,	-0.0909711678847030 - 0.114651158755971*I,	-0.0123589117274881 - 0.0535927383449640*I,	0.0652232890478051 + 0.0737828370699734*I,	-0.144364080681011 + 0.0204255832742890*I,	-0.114669495846387 + 0.0162911194072054*I,	-0.0336515282354490 + 0.150637838832394*I,	-0.0331366572870092 + 0.0217361685258572*I,	-0.0792935673138820 - 0.0813567750697002*I,	0.0634744215209604 - 0.0139293559275895*I,	0.0645154983345465 - 0.0923296031097981*I,	-0.149815460984001 - 0.0653067950261394*I,	-0.0260627006230411 - 0.0392339052310190*I,	0.0430185486678222 - 0.0984796870913278*I,	0.0612556263329217 + 0.0625717177384289*I,	0.104912545155640 + 0.00419021691798917*I,	-0.0147368528749743 - 0.160817263460687*I,	0.0595398661860728 + 0.0149341343386967*I,	0.0510463724590777 + 0.0584626724772317*I,	-0.129853698824864 + 0.0476376735221861*I,	-0.0120121349550069 + 0.115312365181718*I,	0.0516455674772918 - 0.00456713133592963*I,	0.125472404789678 + 0.0257435101612987*I,	-0.0292297648861521 + 0.106533306444449*I,	-0.150238424553638 + 0.0554262475141345*I,	0.0643681140490008 + 0.0880153378370228*I,	0.00425622264244762 - 0.0282287964756763*I,	0.0988981019626787 - 0.0830743912342874*I,	0.0440907060639363 + 0.111659929030848*I,	-0.0135421244874685 + 0.120398625428305*I,	0.172862660054886 + 3.72016870434089e-18*I,	0.000572413075133387 - 0.120398625428305*I,	0.0539941877993760 - 0.111659929030848*I,	0.105557642198109 + 0.0830743912342874*I,	0.0355218004821204 + 0.0282287964756764*I,	0.0663721921263742 - 0.0880153378370227*I,	-0.123260575981387 - 0.0554262475141345*I,	-0.0571571282437050 - 0.106533306444449*I,	0.102499788090708 - 0.0257435101612987*I,	0.0489755834649609 + 0.00456713133592964*I,	0.00950270048638451 - 0.115312365181718*I,	-0.152778499643596 - 0.0476376735221861*I,	0.0193177469162545 - 0.0584626724772317*I,	0.0651375350368962 - 0.0149341343386967*I,	-0.0227760155707198 + 0.160817263460687*I,	0.135755799688292 - 0.00419021691798916*I,	0.0633394273204474 - 0.0625717177384289*I,	0.0496375640506713 + 0.0984796870913278*I,	-0.0222277967654762 + 0.0392339052310190*I,	-0.120564819684227 + 0.0653067950261394*I,	0.101295236293372 + 0.0923296031097981*I,	0.0565158425254932 + 0.0139293559275895*I,	-0.0690216842703142 + 0.0813567750697002*I,	-0.0605891086192737 - 0.0217361685258572*I,	-0.0217668952426942 - 0.150637838832394*I,	-0.121730521947763 - 0.0162911194072054*I,	-0.125971270008509 - 0.0204255832742890*I,	0.0649384896587833 - 0.0737828370699734*I,	-0.0133099665186374 + 0.0535927383449640*I,	-0.0847424261756114 + 0.114651158755971*I,	0.0701461867355645 + 0.105807639400546*I,	-0.00874350464814422 + 0.0974871323196164*I,	-0.141907797837212 - 5.55653613398821e-19*I,	0.00214881105056115 - 0.0974871323196164*I,	0.0816120267888923 - 0.105807639400546*I,	-0.0816758017038622 - 0.114651158755971*I,	0.00488404550811806 - 0.0535927383449640*I,	0.0816035642750558 + 0.0737828370699734*I,	-0.107353906486278 + 0.0204255832742890*I,	-0.112751123517921 + 0.0162911194072054*I,	-0.0399067954684303 + 0.150637838832394*I,	-0.0740368314017215 + 0.0217361685258572*I,	-0.0428286230972866 - 0.0813567750697002*I,	0.0832205475640133 - 0.0139293559275895*I,	0.0994856907464864 - 0.0923296031097981*I,	-0.159078181645453 - 0.0653067950261394*I,	-0.0557202463513877 - 0.0392339052310190*I,	0.0604943476344830 - 0.0984796870913278*I,	0.0829053189032003 + 0.0625717177384289*I,	0.112973650099396 + 0.00419021691798917*I,	-0.0109267660735199 - 0.160817263460687*I,	0.0776098936819300 + 0.0149341343386967*I,	0.0149811997764908 + 0.0584626724772317*I,	-0.117762803038593 + 0.0476376735221861*I,	0.00638073655832280 + 0.115312389919428*I,	0.0378168375121701 - 0.00456482437465336*I,	0.100232251240566 + 0.0257588143894126*I,	-0.0397505819087383 + 0.106540008701027*I,	-0.0991053693645923 + 0.0553018239404263*I,	0.0472068122119914 + 0.0881790542648653*I,	0.0293535355234266 - 0.0278511167317172*I,	0.101750611480585 - 0.0831124151663925*I,	0.0442701670828616 + 0.111421233293452*I,	0.0128335988318829 + 0.120130459204393*I,	-0.0781754300435195 + 0.119828804129721*I,	0.0572141796033192 + 0.0387381452633714*I,	-0.0241412403636320 - 0.140743960895384*I,	-0.0312359730389773 - 0.0566440060417523*I,	0.0606131318748916 - 0.0843465530588114*I,	-0.0998713219405319 - 0.000622253796078040*I,	-0.163079764419336 + 0.0727842969579151*I,	0.0150205631603372 - 0.0366814567532042*I,	-0.0229366957345920 - 0.0128557049272194*I,	-0.0252494386787365 + 0.0621428059529345*I,	0.0864612637604789 + 0.0759735418284281*I,	0.0643932145116576 + 0.0566925588333580*I,	-0.0436593393249818 + 0.0435725069968089*I,	-0.0756232407369920 + 0.0631491070849725*I,	0.0540998307494608 + 0.103252590958222*I,	-0.0147108190692948 - 0.0277229712867022*I,	-0.0761256236245619 - 0.176911640423980*I,	-0.00286661645619384 - 0.0310617864892624*I,	0.0689820138546132 + 0.0813157668335647*I,	0.0556023581866011 + 0.0791941974580523*I,	0.00521607657025232 - 0.0172778708492726*I,	0.00322927384405402 - 0.0932118873235116*I,	-0.0385964522420999 - 0.0202942109647957*I,	-0.0210877770668436 - 0.0164067163301031*I,	0.0498583591004528 + 0.124857175412051*I,	0.0889188721103265 + 0.00808511145119516*I,	0.0536305678600622 - 0.193597387126782*I,	-0.0443362244313311 + 0.0594569537223874*I,	-0.0368868327112321 - 0.0333930721479100*I,	-0.0290372729578428 - 0.0644333949677193*I,	-0.0108354017787807 + 0.117571770700296*I,	0.0602103839776705 + 0.00741876758637598*I,	0.108036531766828 + 0.101887982136031*I,	0.0295265580225459 + 0.0794581235581524*I,	0.0361516148489970 + 0.0287264527140496*I,	0.0349602991696885 + 0.0497927145256090*I,	0.191215119688183 - 0.0849024653918962*I,	0.0714992399731506 + 0.0613760521684337*I,	-0.246986629831492 + 0.0534171425239312*I,	-0.00775058751159888 - 0.0732055584150314*I,	0.0779380636846446 - 0.0310852572405491*I,	-0.167460970552841 - 0.0874922973536806*I,	0.0236050357313256 - 0.0329170149273525*I,	0.128606962561862 + 0.0755208579886964*I,	0.0619770283876700 + 0.125478222968371*I,	0.0335812822109523 + 0.0235168194195707*I,	-0.0530838413414281 - 0.0252354512569892*I,	0.0474148832623105 + 0.0713780360668997*I,	0.0392975579757838 + 0.0440263986235322*I,	-0.147747418547239 + 0.139169163640716*I,	-0.0361939836198761 + 0.0666819200150938*I,	0.0819246076791580 - 0.00913664920159700*I,	0.109667674695222 + 0.0982786337419280*I,	0.0686687829539289 - 0.0983407273394237*I,	-0.0948377041391185 - 0.0167981411007517*I,	-0.0629685895361017 + 0.0638336845139110*I,	-0.104257326973055 - 0.169238477915835*I,	-0.146426531390998 - 0.0834538961561299*I,	-0.0587891168060774 - 0.0634776906226206*I,	0.0483788267925214 - 0.128705924089581*I,	0.0729331565123175 - 0.0469664324925254*I,	-0.0271693916901555 - 0.0173156529358072*I,	0.0230100482023689 - 0.106998693270943*I,	-0.00313952060021119 - 0.114235523379733*I,	-0.0621798404960076 + 0.119324024568540*I,	0.0281331681618151 + 0.0388027708392641*I,	-0.00295911904163608 - 0.140401447845343*I,	-0.0610710509312743 - 0.0571647622566527*I,	0.0647692644569354 - 0.0847895228255040*I,	-0.0958215406618427 - 0.000390263086787752*I,	-0.135387751516258 + 0.0727808945558280*I,	0.00968734786897927 - 0.0367056972967405*I,	-0.0360578124220568 - 0.0128375222285816*I,	0.00221238601054780 + 0.0621345432569875*I,	0.0748255938019855 + 0.0757831415756161*I,	0.0352963578003880 + 0.0571726904307158*I,	-0.0340957467118045 + 0.0436079626483008*I,	-0.0435598011053878 + 0.0632750835248054*I,	0.0400527235296707 + 0.103058457508062*I,	0.00442364818086609 - 0.0280366766535358*I,	-0.216973839171863 + 0.0315552596969421*I,	-0.153739295105817 + 0.0377289090232426*I,	-0.0478435511915388 + 0.105083221865085*I,	0.0358553083537090 - 0.0265375901551703*I,	0.0392895349041445 - 0.114452902600121*I,	0.00791557321150360 + 0.0534104722787302*I,	0.0724277475644527 - 0.0122838292648440*I,	-0.0147246265153130 - 0.00630105697548842*I,	-0.0229845368533676 + 0.0245818777571381*I,	0.0734384132525744 - 0.000391882544689835*I,	-0.0625851522254658 - 0.0224474543876431*I,	0.00698524672349680 - 0.0647693494049947*I,	0.0603682858411395 + 0.00664024739476592*I,	-0.00822534122251835 - 0.0614283658617811*I,	0.139632269142223 - 0.0740675815589170*I,	0.0342782419777036 + 0.0864707689798599*I,	0.0424864948540445 + 0.110516762132181*I,	0.292923108249875 + 0.0844543028909037*I,	-0.0219146047027459 + 0.0706345317117090*I,	-0.106482477025225 - 0.0142623809047901*I,	0.0536039774696243 - 0.0707551266871374*I,	-0.118304224633218 + 0.0682145858711054*I,	-0.129893322662504 + 0.0703534858660852*I,	-0.0382757279053692 + 0.00137135315706689*I,	-0.140147575093797 + 0.144333669993218*I,	-0.0906496636315900 + 0.0487397739407050*I,	0.0371063593974120 - 0.0364019898965657*I,	0.0591635854496311 + 0.0963917465611067*I,	0.0399914435619112 + 0.0834081486648790*I,	-0.0221081140090504 - 0.0329627048216868*I,	-0.0194138198161275 - 0.117635603682616*I,	0.0457167898782368 + 0.0301000422144658*I,	0.0273291315686423 + 0.101594729853089*I,	0.0151652589124868 + 0.00227098602960462*I,	0.0323537206164354 - 0.00625493047150997*I,	-0.128979749036106 - 0.0855220511242270*I,	-0.0203762866164075 - 0.0495699246765864*I,	0.124816686276572 + 0.0302098150685495*I,	-0.0792831644802558 + 0.0816310147990722*I,	-0.134513489336171 + 0.132246833866947*I,	-0.0755523875712729 - 0.0251264591558210*I,	-0.0237400526037134 - 0.0540911928997830*I,	0.0696027778731989 + 0.0299091373999293*I,	0.0275153033228999 + 0.00864520550654986*I,	0.0929024954522683 - 0.0816373316194241*I,	0.185199529613244 - 0.0515841074909632*I,	0.0713614098976348 + 0.110145868756405*I,	-0.104714096569968 + 0.0185171648388003*I,	-0.107964396411513 + 0.0218944627917773*I,	0.0977747421627833 - 0.00860072000555436*I,	0.102013954418006 - 0.169771331219365*I,	-0.0580583580517353 + 0.0112268346180338*I,	0.0384080812701773 - 0.0306425642098194*I,	-0.0195062362642969 - 0.103516226589137*I,	-0.0899318251043359 - 0.0142696785608374*I,	0.0323754324258942 - 0.0797691253561430*I,	-0.0422042795199843 - 0.0554462844164074*I,	-0.0288821582014762 - 0.110607432964592*I,	0.0353053996285364 + 0.0289403068842795*I,	-0.0463430220029891 + 0.0760831639682695*I,	-0.101529042500650 - 0.0967508816662246*I,	0.00132807256403103 + 0.0984459292236057*I,	0.134054203154115 - 0.0438710172326141*I,	0.0105541312985430 - 0.183557417608180*I,	-0.241860141170874 + 0.0317163130984460*I,	-0.153418775352496 + 0.0372860050917493*I,	-0.0199489013345393 + 0.105391729979166*I,	0.0576148013552078 - 0.0268529765957199*I,	0.0282908384313488 - 0.114754652301950*I,	0.0149639344253560 + 0.0535612672245352*I,	0.123845003459322 - 0.0122865112317335*I,	-0.00952872715747776 - 0.00632193024549679*I,	-0.0201541901972963 + 0.0245659266569325*I,	0.0711161019923606 - 0.000393560589149442*I,	-0.0646650936316122 - 0.0223495176389027*I,	0.0385163766828205 - 0.0649813657779662*I,	0.0808222767889768 + 0.00655157704781437*I,	-0.0259885636224711 - 0.0615866518426679*I,	0.124197541024585 - 0.0740618927267794*I,	0.0101358177450617 + 0.0867053668474297*I};

    int start1 = Short_preamble_slot_length * 5;
    int start2 = Short_preamble_slot_length * 6;
    
    double complex vec1[Short_preamble_slot_length];
    double complex vec2[Short_preamble_slot_length];
    
    // Extract first vector
    for (int i = 0; i < Short_preamble_slot_length; i++) {
        vec1[i] = rx_frame[start1 + i];
    }
    
    for (int i = 0; i < Short_preamble_slot_length; i++) {
        vec2[i] = rx_frame[start2 + i];
    }

    double complex prod_consq_frame_coarse = 0;
    for (int i = 0; i < Short_preamble_slot_length; i++) {
        prod_consq_frame_coarse += vec1[i] * conj(vec2[i]);
    }

    // Compute freq_coarse_est
    double freq_coarse_est = (-1.0 / (2 * PI * Short_preamble_slot_length * ts_sec)) *atan2(cimag(prod_consq_frame_coarse), creal(prod_consq_frame_coarse));

 // Assume this is initialized earlier
    double complex rx_frame_after_coarse[480];
    
    for (int i = 0; i < 480; i++) {
        rx_frame_after_coarse[i] = rx_frame[i] * cexp(-I * 2 * PI * freq_coarse_est * ts_sec * i);
    }

//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Fine CFO Estimation %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    start1 = Short_preamble_slot_length * 12;
    start2 = Short_preamble_slot_length * 16;
    int length= Short_preamble_slot_length * 4;

    double complex prod_consq_frame_fine = 0 + 0 * I;

    for (int i = 0; i < length; i++) {
        prod_consq_frame_fine += rx_frame_after_coarse[start1 + i] * conj(rx_frame_after_coarse[start2 + i]);
    }

    // Step 2: Estimate the fine frequency offset
    double freq_fine_est = (-1.0 / (2 * PI * 64 * ts_sec)) *
                           atan2(cimag(prod_consq_frame_fine), creal(prod_consq_frame_fine));

    // Step 3: Apply the fine frequency offset to rx_frame_after_coarse
    double complex rx_frame_after_fine[FRAME_TX_LENGTH];

    for (int i = 0; i < FRAME_TX_LENGTH; i++) {
        double complex exp_term = cexp(-1.0 * I * 2 * PI * freq_fine_est * ts_sec * i);
        rx_frame_after_fine[i] = rx_frame_after_coarse[i] * exp_term;
    }

//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Channel Estimation %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

    double complex Long_preamble_1[N_FFT];
    double complex Long_preamble_2[N_FFT];

    for (int i = 0; i < N_FFT; i++) {
        Long_preamble_1[i] = rx_frame_after_fine[Short_preamble_slot_length * 12 + i];
        Long_preamble_2[i] = rx_frame_after_fine[Short_preamble_slot_length * 16 + i];
    }

    double complex *Long_preamble_1_After_FFT=fft(Long_preamble_1,N_FFT);
    Long_preamble_1_After_FFT=fftshift(Long_preamble_1_After_FFT,N_FFT);

    double complex *Long_preamble_2_After_FFT=fft(Long_preamble_2,N_FFT);
    Long_preamble_2_After_FFT=fftshift(Long_preamble_2_After_FFT,N_FFT);

    int Long_preamble_slot_Frequency[N_FFT] = {0,0,0,0,0,0,1,1,-1,-1,1,1,-1,1,-1,1,1,1,1,1,1,-1,-1,1,1,-1,1,-1,1,1,1,1,0,1,-1,-1,1,1,-1,1,-1,1,-1,-1,-1,-1,-1,1,1,-1,-1,1,-1,1,-1,1,1,1,1,0,0,0,0,0};
    double complex H_est[N_FFT];

    for (int i = 0; i < N_FFT; i++) {
        H_est[i] = 0.5 * (Long_preamble_1_After_FFT[i] + Long_preamble_2_After_FFT[i]) * (Long_preamble_slot_Frequency[i]);
    }

//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% One Tap Equalizer %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    double complex RX_Payload_1_time[80];
    int index=0;
    for(int i=320;i<400;i++){
        RX_Payload_1_time[index]=rx_frame_after_fine[i];
        index++;
    }

    double complex RX_Payload_1_no_CP[N_FFT];
    index=0;

    for(int i=16;i<80;i++){
        RX_Payload_1_no_CP[index]=RX_Payload_1_time[i];
        index++;
    }

    double complex *RX_Payload_1_Frequency=fft(RX_Payload_1_no_CP,N_FFT);
    RX_Payload_1_Frequency=fftshift(RX_Payload_1_Frequency,N_FFT);
 
    double complex RX_Payload_1_Frequency_Equalizer[N_FFT];

    for(int i=0;i<N_FFT;i++){
        RX_Payload_1_Frequency_Equalizer[i]=RX_Payload_1_Frequency[i]/H_est[i];
    }

    double complex RX_Payload_2_time[80];
    index=0;
    for(int i=400;i<480;i++){
        RX_Payload_2_time[index]=rx_frame_after_fine[i];
        index++;
    }

    double complex RX_Payload_2_no_CP[N_FFT];
    index=0;

    for(int i=16;i<80;i++){
        RX_Payload_2_no_CP[index]=RX_Payload_2_time[i];
        index++;
    }

    double complex *RX_Payload_2_Frequency=fft(RX_Payload_2_no_CP,N_FFT);
    RX_Payload_2_Frequency=fftshift(RX_Payload_2_Frequency,N_FFT);

    double complex RX_Payload_2_Frequency_Equalizer[N_FFT];

    for(int i=0;i<N_FFT;i++){
        RX_Payload_2_Frequency_Equalizer[i]=RX_Payload_2_Frequency[i]/H_est[i];
    }

//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% De-Mapping %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    double complex RX_Payload_1_no_Equalizer[48];
    double complex RX_Payload_2_no_Equalizer[48];
    index = 0;

    // RX_Payload_1_Frequency(7:11)
    for (int i = 6; i < 11; i++) {
        RX_Payload_1_no_Equalizer[index] = RX_Payload_1_Frequency[i];
        RX_Payload_2_no_Equalizer[index] = RX_Payload_2_Frequency[i];
        index++;
        
    }

    // RX_Payload_1_Frequency(13:25)
    for (int i = 12; i < 25; i++) {
        RX_Payload_1_no_Equalizer[index] = RX_Payload_1_Frequency[i];
        RX_Payload_2_no_Equalizer[index] = RX_Payload_2_Frequency[i];
        index++;
    }

    // RX_Payload_1_Frequency(27:32)
    for (int i = 26; i < 32; i++) {
        RX_Payload_1_no_Equalizer[index] = RX_Payload_1_Frequency[i];
        RX_Payload_2_no_Equalizer[index] = RX_Payload_2_Frequency[i];
        index++;
    }

    // RX_Payload_1_Frequency(34:39)
    for (int i = 33; i < 39; i++) {
        RX_Payload_1_no_Equalizer[index] = RX_Payload_1_Frequency[i];
        RX_Payload_2_no_Equalizer[index] = RX_Payload_2_Frequency[i];
        index++;
    }

    // RX_Payload_1_Frequency(41:53)
    for (int i = 40; i < 53; i++) {
        RX_Payload_1_no_Equalizer[index] = RX_Payload_1_Frequency[i];
        RX_Payload_2_no_Equalizer[index] = RX_Payload_2_Frequency[i];
        index++;
    }

    // RX_Payload_1_Frequency(55:59)
    for (int i = 54; i < 59; i++) {
        RX_Payload_1_no_Equalizer[index] = RX_Payload_1_Frequency[i];
        RX_Payload_2_no_Equalizer[index] = RX_Payload_2_Frequency[i];
        index++;
    }

    double complex RX_Payload_1_no_pilot[48];
    double complex RX_Payload_2_no_pilot[48];

    index = 0;

    // RX_Payload_1_Frequency(7:11)
    for (int i = 6; i < 11; i++) {
        RX_Payload_1_no_pilot[index] = RX_Payload_1_Frequency_Equalizer[i];
        RX_Payload_2_no_pilot[index] = RX_Payload_2_Frequency_Equalizer[i];
        index++;
        
    }

    // RX_Payload_1_Frequency(13:25)
    for (int i = 12; i < 25; i++) {
        RX_Payload_1_no_pilot[index] = RX_Payload_1_Frequency_Equalizer[i];
        RX_Payload_2_no_pilot[index] = RX_Payload_2_Frequency_Equalizer[i];
        index++;
    }

    // RX_Payload_1_Frequency(27:32)
    for (int i = 26; i < 32; i++) {
        RX_Payload_1_no_pilot[index] = RX_Payload_1_Frequency_Equalizer[i];
        RX_Payload_2_no_pilot[index] = RX_Payload_2_Frequency_Equalizer[i];
        index++;
    }

    // RX_Payload_1_Frequency(34:39)
    for (int i = 33; i < 39; i++) {
        RX_Payload_1_no_pilot[index] = RX_Payload_1_Frequency_Equalizer[i];
        RX_Payload_2_no_pilot[index] = RX_Payload_2_Frequency_Equalizer[i];
        index++;
    }

    // RX_Payload_1_Frequency(41:53)
    for (int i = 40; i < 53; i++) {
        RX_Payload_1_no_pilot[index] = RX_Payload_1_Frequency_Equalizer[i];
        RX_Payload_2_no_pilot[index] = RX_Payload_2_Frequency_Equalizer[i];
        index++;
    }

    // RX_Payload_1_Frequency(55:59)
    for (int i = 54; i < 59; i++) {
        RX_Payload_1_no_pilot[index] = RX_Payload_1_Frequency_Equalizer[i];
        RX_Payload_2_no_pilot[index] = RX_Payload_2_Frequency_Equalizer[i];
        index++;
    }

//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% AGC For Rx Data Payload %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

    double complex RX_Payload_1_Final[48]={0};
    double complex RX_Payload_1_no_pilot_current;
    double RX_Payload_1_mapped_real = 0; 
    double RX_Payload_1_mapped_imag = 0;

    double complex RX_Payload_2_Final[48]={0};
    double complex RX_Payload_2_no_pilot_current;
    double RX_Payload_2_mapped_real = 0; 
    double RX_Payload_2_mapped_imag = 0;

    for(int i=0;i<(sizeof(RX_Payload_1_no_pilot)/sizeof(RX_Payload_1_no_pilot[0]));i++){
        RX_Payload_1_no_pilot_current=RX_Payload_1_no_pilot[i];

        if(creal(RX_Payload_1_no_pilot_current)>0){
            RX_Payload_1_mapped_real= 1/sqrt(2);
        }
        else if(creal(RX_Payload_1_no_pilot_current)<0){
            RX_Payload_1_mapped_real= -1/sqrt(2);
        }

        if(cimag(RX_Payload_1_no_pilot_current)>0){
            RX_Payload_1_mapped_imag = 1/sqrt(2);
        }
        else if(cimag(RX_Payload_1_no_pilot_current)<0){
            RX_Payload_1_mapped_imag = -1/sqrt(2);
        }
        RX_Payload_1_Final[i] = RX_Payload_1_mapped_real + I * RX_Payload_1_mapped_imag;

        RX_Payload_2_no_pilot_current=RX_Payload_2_no_pilot[i];

        if(creal(RX_Payload_2_no_pilot_current)>0){
            RX_Payload_2_mapped_real= 1/sqrt(2);
        }
        else if(creal(RX_Payload_2_no_pilot_current)<0){
            RX_Payload_2_mapped_real= -1/sqrt(2);
        }

        if(cimag(RX_Payload_2_no_pilot_current)>0){
            RX_Payload_2_mapped_imag = 1/sqrt(2);
        }
        else if(cimag(RX_Payload_2_no_pilot_current)<0){
            RX_Payload_2_mapped_imag = -1/sqrt(2);
        }
        RX_Payload_2_Final[i] = RX_Payload_2_mapped_real + I * RX_Payload_2_mapped_imag; 
    }

//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% QPSK Demdoulation For Rx Data Payload 1 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
        
    double RX_Payload_1_demod[size_96]={0};

    for (int i = 0; i < size_48; i++) {
        double RX_Payload_1_demod_real = creal(RX_Payload_1_Final[i]);
        double RX_Payload_1_demod_imag = cimag(RX_Payload_1_Final[i]);
        
        if (RX_Payload_1_demod_real > 0 && RX_Payload_1_demod_imag > 0) {
            RX_Payload_1_demod[2 * i] = 0;
            RX_Payload_1_demod[2 * i + 1] = 0;
        } else if (RX_Payload_1_demod_real < 0 && RX_Payload_1_demod_imag > 0) {
            RX_Payload_1_demod[2 * i] = 0; 
            RX_Payload_1_demod[2 * i + 1] = 1;
        } else if (RX_Payload_1_demod_real < 0 && RX_Payload_1_demod_imag < 0) {
            RX_Payload_1_demod[2 * i] = 1;
            RX_Payload_1_demod[2 * i + 1] = 0;
        } else if (RX_Payload_1_demod_real > 0 && RX_Payload_1_demod_imag < 0) {
            RX_Payload_1_demod[2 * i] = 1;
            RX_Payload_1_demod[2 * i + 1] = 1;
        }
    }

    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% QPSK Demdoulation For Rx Data Payload 2 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    double RX_Payload_2_demod[size_96]={0};

    for (int i = 0; i < size_48; i++) {
        double RX_Payload_2_demod_real = creal(RX_Payload_2_Final[i]);
        double RX_Payload_2_demod_imag = cimag(RX_Payload_2_Final[i]);
        
        if (RX_Payload_2_demod_real > 0 && RX_Payload_2_demod_imag > 0) {
            RX_Payload_2_demod[2 * i] = 0;
            RX_Payload_2_demod[2 * i + 1] = 0;
        } else if (RX_Payload_2_demod_real < 0 && RX_Payload_2_demod_imag > 0) {
            RX_Payload_2_demod[2 * i] = 0;
            RX_Payload_2_demod[2 * i + 1] = 1;
        } else if (RX_Payload_2_demod_real < 0 && RX_Payload_2_demod_imag < 0) {
            RX_Payload_2_demod[2 * i] = 1;
            RX_Payload_2_demod[2 * i + 1] = 0;
        } else if (RX_Payload_2_demod_real > 0 && RX_Payload_2_demod_imag < 0) {
            RX_Payload_2_demod[2 * i] = 1;
            RX_Payload_2_demod[2 * i + 1] = 1;
        }
    }

    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% EVM Calculation (Before AGC) %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  

    double complex data_payload1_mod[48]={0.707106781186548 - 0.707106781186548*I,	-0.707106781186548 + 0.707106781186548*I,	-0.707106781186548 - 0.707106781186548*I,
            -0.707106781186548 + 0.707106781186548*I,	0.707106781186548 - 0.707106781186548*I,	-0.707106781186548 + 0.707106781186548*I,	
            -0.707106781186548 - 0.707106781186548*I,	-0.707106781186548 - 0.707106781186548*I,	-0.707106781186548 + 0.707106781186548*I,	
            0.707106781186548 - 0.707106781186548*I,	-0.707106781186548 - 0.707106781186548*I,	0.707106781186548 - 0.707106781186548*I,	
            0.707106781186548 - 0.707106781186548*I,	-0.707106781186548 - 0.707106781186548*I,	-0.707106781186548 - 0.707106781186548*I,	
            -0.707106781186548 - 0.707106781186548*I,	0.707106781186548 + 0.707106781186548*I,	-0.707106781186548 + 0.707106781186548*I,	
            -0.707106781186548 - 0.707106781186548*I,	-0.707106781186548 - 0.707106781186548*I,	0.707106781186548 + 0.707106781186548*I,	
            0.707106781186548 - 0.707106781186548*I,	0.707106781186548 + 0.707106781186548*I,	-0.707106781186548 + 0.707106781186548*I,	
            0.707106781186548 - 0.707106781186548*I,	-0.707106781186548 + 0.707106781186548*I,	-0.707106781186548 - 0.707106781186548*I,	
            0.707106781186548 + 0.707106781186548*I,	-0.707106781186548 - 0.707106781186548*I,	-0.707106781186548 - 0.707106781186548*I,	
            -0.707106781186548 - 0.707106781186548*I,	0.707106781186548 - 0.707106781186548*I,	0.707106781186548 - 0.707106781186548*I,	
            -0.707106781186548 - 0.707106781186548*I,	0.707106781186548 + 0.707106781186548*I,	-0.707106781186548 - 0.707106781186548*I,	
            -0.707106781186548 - 0.707106781186548*I,	-0.707106781186548 - 0.707106781186548*I,	0.707106781186548 + 0.707106781186548*I,	
            -0.707106781186548 - 0.707106781186548*I,	-0.707106781186548 + 0.707106781186548*I,	0.707106781186548 - 0.707106781186548*I,	
            -0.707106781186548 - 0.707106781186548*I,	0.707106781186548 - 0.707106781186548*I,	-0.707106781186548 + 0.707106781186548*I,	
            0.707106781186548 + 0.707106781186548*I,	0.707106781186548 - 0.707106781186548*I,	-0.707106781186548 - 0.707106781186548*I};

    double complex data_payload2_mod[48]={-0.707106781186548 - 0.707106781186548*I,	0.707106781186548 + 0.707106781186548*I,	-0.707106781186548 + 0.707106781186548*I,
            -0.707106781186548 + 0.707106781186548*I,	-0.707106781186548 + 0.707106781186548*I,	-0.707106781186548 + 0.707106781186548*I,	
            0.707106781186548 - 0.707106781186548*I,	0.707106781186548 + 0.707106781186548*I,	-0.707106781186548 + 0.707106781186548*I,	
            -0.707106781186548 + 0.707106781186548*I,	0.707106781186548 - 0.707106781186548*I,	0.707106781186548 + 0.707106781186548*I,	
            -0.707106781186548 + 0.707106781186548*I,	-0.707106781186548 + 0.707106781186548*I,	0.707106781186548 - 0.707106781186548*I,	
            0.707106781186548 + 0.707106781186548*I,	-0.707106781186548 + 0.707106781186548*I,	-0.707106781186548 + 0.707106781186548*I,	
            0.707106781186548 + 0.707106781186548*I,	0.707106781186548 + 0.707106781186548*I,	0.707106781186548 - 0.707106781186548*I,	
            -0.707106781186548 - 0.707106781186548*I,	0.707106781186548 - 0.707106781186548*I,	-0.707106781186548 + 0.707106781186548*I,	
            0.707106781186548 + 0.707106781186548*I,	0.707106781186548 + 0.707106781186548*I,	0.707106781186548 + 0.707106781186548*I,	
            0.707106781186548 + 0.707106781186548*I,	0.707106781186548 - 0.707106781186548*I,	0.707106781186548 + 0.707106781186548*I,	
            -0.707106781186548 + 0.707106781186548*I,	0.707106781186548 + 0.707106781186548*I,	-0.707106781186548 - 0.707106781186548*I,	
            0.707106781186548 + 0.707106781186548*I,	0.707106781186548 + 0.707106781186548*I,	0.707106781186548 - 0.707106781186548*I,	
            -0.707106781186548 - 0.707106781186548*I,	0.707106781186548 + 0.707106781186548*I,	-0.707106781186548 - 0.707106781186548*I,	
            0.707106781186548 + 0.707106781186548*I,	0.707106781186548 - 0.707106781186548*I,	-0.707106781186548 - 0.707106781186548*I,	
            -0.707106781186548 - 0.707106781186548*I,	-0.707106781186548 - 0.707106781186548*I,	-0.707106781186548 - 0.707106781186548*I,	
            -0.707106781186548 + 0.707106781186548*I,	-0.707106781186548 - 0.707106781186548*I,	0.707106781186548 - 0.707106781186548*I};

    double complex error_vector[size_96];

    for(int i=0;i<size_48;i++){
        error_vector[i] = RX_Payload_1_no_pilot[i] - data_payload1_mod[i];
        error_vector[i + 48] = RX_Payload_2_no_pilot[i] - data_payload2_mod[i];
    }  

    double error_term=0;
    double payload_term=0;

    for (int i = 0; i < size_96; i++) {
        error_term += creal(error_vector[i]) * creal(error_vector[i]) + cimag(error_vector[i]) * cimag(error_vector[i]);
    }

    for (int i = 0; i < size_48; i++) {
        payload_term += creal(data_payload1_mod[i]) * creal(data_payload1_mod[i]) + cimag(data_payload1_mod[i]) * cimag(data_payload1_mod[i]);
        payload_term += creal(data_payload2_mod[i]) * creal(data_payload2_mod[i]) + cimag(data_payload2_mod[i]) * cimag(data_payload2_mod[i]);
    }

    double evm = sqrt(error_term / size_96) / sqrt(payload_term / (2 * size_48));

    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% EVM Calculation (After AGC) %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  

    double complex error_vector_AGC[size_96];

    for(int i=0;i<size_48;i++){
        error_vector_AGC[i] = RX_Payload_1_Final[i] - data_payload1_mod[i];
        error_vector_AGC[i + 48] = RX_Payload_2_Final[i] - data_payload2_mod[i];
    }   

    double error_term_AGC=0;
    double payload_term_AGC=0;

    for(int i=0;i<size_96;i++){
        error_term_AGC+=creal(error_vector_AGC[i])*creal(error_vector_AGC[i]) + cimag(error_vector_AGC[i])*cimag(error_vector_AGC[i]);
    }

    for (int i=0;i<size_48;i++){
        payload_term_AGC+=creal(data_payload1_mod[i])*creal(data_payload1_mod[i]) + cimag(data_payload1_mod[i])*cimag(data_payload1_mod[i]);
        payload_term_AGC+=creal(data_payload2_mod[i])*creal(data_payload2_mod[i]) + cimag(data_payload2_mod[i])*cimag(data_payload2_mod[i]);
    }   

    double evm_AGC=sqrt(error_term_AGC/size_96)/sqrt(payload_term_AGC/size_96);

    double evm_AGC_dB=20*log10(evm_AGC);

    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% BER Calculation %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

    //Error_bits = sum([abs(sign(data_payload_1-RX_Payload_1_demod)),abs( (data_payload_2-RX_Payload_2_demod))]);

    double data_payload_1[size_96]={1,1,0,1,1,0,0,1,1,1,0,1,1,0,1,0,0,1,1,1,1,0,1,1,1,1,1,0,1,0,1,0,0,0,0,1,1,0,1,0,0,0,1,1,0,0,0,1,1,1,0,1,1,0,0,0,1,0,1,0,1,0,1,1,1,1,1,0,0,0,1,0,1,0,1,0,0,0,1,0,0,1,1,1,1,0,1,1,0,1,0,0,1,1,1,0};
    double data_payload_2[size_96]={1,0,0,0,0,1,0,1,0,1,0,1,1,1,0,0,0,1,0,1,1,1,0,0,0,1,0,1,1,1,0,0,0,1,0,1,0,0,0,0,1,1,1,0,1,1,0,1,0,0,0,0,0,0,0,0,1,1,0,0,0,1,0,0,1,0,0,0,0,0,1,1,1,0,0,0,1,0,0,0,1,1,1,0,1,0,1,0,1,0,0,1,1,0,1,1};

    double error_bits=0;
    double complex payload_1_term;
    double complex payload_2_term;

    for(int i=0;i<size_96;i++){
        payload_1_term=sign_complex(data_payload_1[i]-RX_Payload_1_demod[i]);
        payload_1_term=cabs(payload_1_term);
        payload_2_term=cabs(data_payload_2[i]-RX_Payload_2_demod[i]);
        error_bits+=payload_1_term+payload_2_term;        
    }

    double BER=error_bits/((sizeof(data_payload_1)/sizeof(data_payload_1[0]))+(sizeof(data_payload_2)/sizeof(data_payload_2[0])));

    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% BER Calculation %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

    double evm_dB_values[size_snr_db];
    double evm_AGC_dB_values[size_snr_db]={-0.477727818,-0.477727818,-0.684573807,-12.04119983,-13.80211242,-16.81241237,-3147.282496,-3147.282496,-3147.282496,-3147.282496};
    double BER_values[size_snr_db]={0.3125,0.302083333,0.286458333,0.026041667,0.020833333,0.005208333,0,0,0,0};

    check_values(evm_AGC_dB_values,-3100,-40);
    check_values(BER_values,0,1e-6);

    return 0;
}
